<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PinkyCode Results</title>
  <style>
    :root {
      --color-pink: #f8d1d9;
      --color-pink-dark: #e6a5b3;
      --color-green-light: #e6f4ea;
      --color-gray-light: #f2f2f2;
      --color-gray: #777;
      --color-text: #333;
      --spacing: 16px;
      --header-height: 60px;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: sans-serif; color: var(--color-text); background: #fff; }
    header {
      background: var(--color-pink);
      height: var(--header-height);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 var(--spacing);
      border-bottom: 1px solid #ccc;
    }
    header .logo {
      font-weight: bold;
      background: #fff;
      padding: 4px 8px;
      border-radius: 4px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.2);
    }
    header .user-icon {
      width: 32px; height: 32px;
      border-radius: 50%;
      background: #fff;
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 1px 3px rgba(0,0,0,0.2);
    }
    header .user-icon::after {
      content: '';
      width: 12px; height: 12px;
      background: var(--color-pink-dark);
      border-radius: 50%;
      position: absolute;
      top: -4px; right: -4px;
    }
    main {
      display: flex;
      padding: var(--spacing);
      gap: var(--spacing);
    }
    .left-panel, .right-panel {
      background: #fff;
      padding: var(--spacing);
      border: 1px solid #ccc;
      border-radius: 8px;
    }
    .left-panel {
      flex: 1;
      background: var(--color-green-light);
    }
    .right-panel {
      flex: 2;
    }
    .upload-container {
      margin-bottom: calc(var(--spacing) * 2);
      display: flex;
      justify-content: center;
    }
    .upload-container input[type=file] {
      display: none;
    }
    .upload-container label {
      background: #fff;
      padding: 12px 24px;
      border: 1px solid #ccc;
      border-radius: 4px;
      cursor: pointer;
      font-size: 1rem;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .section {
      margin-bottom: calc(var(--spacing) * 2);
    }
    .section h3 {
      margin-bottom: 8px;
      font-size: 1rem;
    }
    .toggle-group {
      display: flex;
      gap: 8px;
      margin-top: 8px;
    }
    .toggle-group input[type=radio] { display: none; }
    .toggle-group label {
      flex: 1;
      text-align: center;
      padding: 8px 0;
      border: 2px solid var(--color-pink-dark);
      border-radius: 20px;
      cursor: pointer;
      background: #fff;
      position: relative;
      font-size: 0.95rem;
    }
    .toggle-group input[type=radio]:checked + label {
      background: var(--color-pink);
      color: #fff;
      border-color: var(--color-pink);
    }
    .prog-group {
      display: flex;
      gap: 8px;
      margin-top: 8px;
    }
    .prog-group input[type=radio] { display: none; }
    .prog-group label {
      flex: 1;
      text-align: center;
      padding: 8px 0;
      border: 2px solid var(--color-gray);
      border-radius: 20px;
      cursor: pointer;
      background: #fff;
      font-size: 0.9rem;
    }
    .prog-group input[type=radio]:checked + label {
      background: var(--color-pink);
      border-color: var(--color-pink);
      color: #fff;
    }
    .slider-group {
      margin-top: 8px;
    }
    .slider-track {
      position: relative;
      height: 4px;
      background: #fff;
      border: 1px solid #ccc;
      border-radius: 2px;
      margin: 16px 0 8px;
    }
    .slider-track .dot {
      position: absolute;
      width: 16px; height: 16px;
      border-radius: 50%;
      background: var(--color-gray);
      border: 2px solid #ccc;
      transform: translate(-50%, -50%);
      top: 50%;
      cursor: pointer;
    }
    .percent-labels {
      display: flex;
      justify-content: space-between;
      font-size: 0.75rem;
      color: var(--color-gray);
    }
    .slider-options {
      display: flex;
      justify-content: space-between;
      position: relative;
      padding: 0 8px;
    }
    .slider-options input[type=radio] {
      position: absolute;
      opacity: 0;
      width: 16px;
      height: 16px;
      top: 0;
      transform: translateX(-8px);
    }
    .slider-options input[type=radio]:checked + .dot {
      background: var(--color-pink);
      border-color: var(--color-pink-dark);
    }
    .results-title {
      font-size: 1.5rem;
      color: var(--color-pink-dark);
      margin-bottom: 16px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 24px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: left;
    }
    th {
      background: var(--color-gray-light);
    }
    tr:nth-child(even) {
      background: var(--color-gray-light);
    }
    .download-container {
      display: flex;
      justify-content: center;
    }
    .download-container button {
      background: var(--color-pink);
      color: #fff;
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1rem;
      box-shadow: 0 1px 3px rgba(0,0,0,0.2);
    }
  </style>
</head>
<body>
  <header>
    <div class="logo">PinkyCode</div>
    <div class="user-icon">
      <!-- user icon placeholder -->
    </div>
  </header>
  <main>
    <div class="left-panel">
      <div class="upload-container">
        <input type="file" id="file-upload">
        <label for="file-upload">Upload File</label>
      </div>
      <div class="section">
        <h3>Choose comments language:</h3>
        <div class="toggle-group">
          <input type="radio" id="lang-en" name="comment-lang" value="en" checked>
          <label for="lang-en">English</label>
          <input type="radio" id="lang-ru" name="comment-lang" value="ru">
          <label for="lang-ru">Russian</label>
        </div>
      </div>
      <div class="section">
        <h3>Choose programming language:</h3>
        <div class="prog-group">
          <input type="radio" id="lang-java" name="prog-lang" value="java">
          <label for="lang-java">JAVA</label>
          <input type="radio" id="lang-c" name="prog-lang" value="c">
          <label for="lang-c">C</label>
          <input type="radio" id="lang-cpp" name="prog-lang" value="cpp">
          <label for="lang-cpp">C++</label>
          <input type="radio" id="lang-csharp" name="prog-lang" value="csharp" checked>
          <label for="lang-csharp">C#</label>
        </div>
      </div>
      <div class="section slider-group">
        <h3>Density:</h3>
        <div class="slider-track"></div>
        <div class="slider-options">
          <input type="radio" id="density-0" name="density" value="0" style="left:0%;" checked>
          <label class="dot" for="density-0" style="left:0%;"></label>
          <input type="radio" id="density-25" name="density" value="25" style="left:25%;">
          <label class="dot" for="density-25" style="left:25%;"></label>
          <input type="radio" id="density-50" name="density" value="50" style="left:50%;">
          <label class="dot" for="density-50" style="left:50%;"></label>
          <input type="radio" id="density-75" name="density" value="75" style="left:75%;">
          <label class="dot" for="density-75" style="left:75%;"></label>
          <input type="radio" id="density-100" name="density" value="100" style="left:100%;">
          <label class="dot" for="density-100" style="left:100%;"></label>
        </div>
        <div class="percent-labels">
          <span>0%</span><span>25%</span><span>50%</span><span>75%</span><span>100%</span>
        </div>
      </div>
      <div class="section slider-group">
        <h3>Commented:</h3>
        <div class="slider-track"></div>
        <div class="slider-options">
          <input type="radio" id="comm-0" name="commented" value="0" style="left:0%;" checked>
          <label class="dot" for="comm-0" style="left:0%;"></label>
          <input type="radio" id="comm-25" name="commented" value="25" style="left:25%;">
          <label class="dot" for="comm-25" style="left:25%;"></label>
          <input type="radio" id="comm-50" name="commented" value="50" style="left:50%;">
          <label class="dot" for="comm-50" style="left:50%;"></label>
          <input type="radio" id="comm-75" name="commented" value="75" style="left:75%;" checked>
          <label class="dot" for="comm-75" style="left:75%;"></label>
          <input type="radio" id="comm-100" name="commented" value="100" style="left:100%;">
          <label class="dot" for="comm-100" style="left:100%;"></label>
        </div>
        <div class="percent-labels">
          <span>0%</span><span>25%</span><span>50%</span><span>75%</span><span>100%</span>
        </div>
      </div>
    </div>
    <div class="right-panel">
      <div class="results-title">Results:</div>
      <table>
        <thead>
          <tr><th>Filename</th><th>Density</th><th>Methods%</th><th>Readability</th><th>Meaningless%</th><th>Issues</th></tr>
        </thead>
        <tbody id="results-body">
          <!-- Rows populated via JS -->
        </tbody>
      </table>
      <div class="download-container">
        <button id="download-btn">Download CSV</button>
      </div>
    </div>
  </main>
  <script>
    function getSelectedValue(name) {
      const el = document.querySelector(`input[name="${name}"]:checked`);
      return el ? el.value : null;
    }

    async function evaluateFileOnServer(content, filename, options) {
      // Sends content and options to backend endpoint /api/evaluate
      // Assumes backend handles JSON with fields: filename, content, options
      try {
        const resp = await fetch('/api/evaluate', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ filename, content, options })
        });
        if (!resp.ok) throw new Error(`Server error: ${resp.status}`);
        const data = await resp.json();
        // Expect data format: [{ filename, density, methods_pct, readability, meaningless_pct, issues: ["line:desc", ...] }, ...]
        return data;
      } catch (err) {
        console.error('Error calling server evaluate:', err);
        alert('Error evaluating file: ' + err.message);
        return [];
      }
    }

    function populateResults(data) {
      const tbody = document.getElementById('results-body');
      tbody.innerHTML = '';
      data.forEach(item => {
        const tr = document.createElement('tr');
        const issuesStr = Array.isArray(item.issues) ? item.issues.join(' | ') : '';
        [item.filename, item.density, item.methods_pct, item.readability, item.meaningless_pct, issuesStr].forEach(val => {
          const td = document.createElement('td');
          td.textContent = val;
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });
    }

    document.getElementById('file-upload').addEventListener('change', async function(event) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = async function(e) {
        const content = e.target.result;
        const filename = file.name;
        const options = {
          commentLang: getSelectedValue('comment-lang'),
          progLang: getSelectedValue('prog-lang'),
          density: getSelectedValue('density'),
          commented: getSelectedValue('commented')
        };
        // Call backend to evaluate
        const results = await evaluateFileOnServer(content, filename, options);
        populateResults(results);
      };
      reader.readAsText(file);
    });

    document.getElementById('download-btn').addEventListener('click', function() {
      const rows = [];
      const headers = ['Filename','Density','Methods%','Readability','Meaningless%','Issues'];
      rows.push(headers.join(','));
      document.querySelectorAll('#results-body tr').forEach(tr => {
        const cols = Array.from(tr.children).map(td => td.textContent.replace(/,/g, ''));
        rows.push(cols.join(','));
      });
      const csvContent = rows.join('\n');
      const blob = new Blob([csvContent], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'results.csv';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    });
  </script>
</body>
</html>
